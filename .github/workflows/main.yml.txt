name: Build TXD Tool
on: [push]
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Compile Metal Shaders
        run: |
          mkdir -p build
          xcrun -sdk iphoneos metal \
            -c App/Shaders.metal \
            -o build/Shaders.air
          xcrun -sdk iphoneos metallib \
            build/Shaders.air \
            -o build/default.metallib
      
      - name: Force Compile Binary
        run: |
          mkdir -p build/Release-iphoneos
          swiftc -o build/Release-iphoneos/TXDTool \
            -sdk $(xcrun --sdk iphoneos --show-sdk-path) \
            -target arm64-apple-ios15.0 \
            -O \
            -framework Foundation \
            -framework UIKit \
            -framework SwiftUI \
            -framework MetalKit \
            -framework CoreImage \
            App/Main.swift \
            App/ContentView.swift
      
      - name: Manual File Injection
        run: |
          mkdir -p Payload/TXDTool.app
          cp build/Release-iphoneos/TXDTool Payload/TXDTool.app/TXDTool
          cp build/default.metallib Payload/TXDTool.app/default.metallib
          cp App/Info.plist Payload/TXDTool.app/Info.plist
          chmod 755 Payload/TXDTool.app/TXDTool
          zip -qry TXDTool.ipa Payload
      
      - uses: actions/upload-artifact@v4
        with:
          name: TXDTool-IPA
          path: TXDTool.ipa
